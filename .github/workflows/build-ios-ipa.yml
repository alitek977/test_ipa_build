name: Build iOS IPA (Expo, Manual Signing)

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ŸÖŸáŸÖ ÿ¨ÿØÿßŸã ŸÑÿ£ŸÜ RN ÿπŸÜÿØŸÉ Ÿäÿ™ÿ∑ŸÑÿ® Xcode >= 16.1
      - name: Select Xcode 16.4
        run: |
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install JS deps
        run: npm ci

      - name: Expo prebuild (iOS)
        run: npx expo prebuild -p ios --no-install

      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      # ---------- Signing: P12 ----------
      - name: Install signing cert into keychain
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${IOS_P12_BASE64:-}" ]; then
            echo "‚ùå IOS_P12_BASE64 is empty"
            exit 1
          fi

          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"

          echo "$IOS_P12_BASE64" | base64 --decode > "$RUNNER_TEMP/cert.p12"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$RUNNER_TEMP/cert.p12" -P "$IOS_P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "üîé Available code signing identities:"
          security find-identity -v -p codesigning || true

      # ---------- Signing: MobileProvision (robust) ----------
      - name: Install provisioning profile + extract TEAM_ID / PROFILE_NAME / BUNDLE_ID / EXPORT_METHOD
        env:
          IOS_MOBILEPROVISION_BASE64: ${{ secrets.IOS_MOBILEPROVISION_BASE64 }}
        run: |
          set -euo pipefail

          if [ -z "${IOS_MOBILEPROVISION_BASE64:-}" ]; then
            echo "‚ùå IOS_MOBILEPROVISION_BASE64 secret is empty"
            exit 1
          fi

          PP_PATH="$RUNNER_TEMP/profile.mobileprovision"
          echo "$IOS_MOBILEPROVISION_BASE64" | base64 --decode > "$PP_PATH"

          # ÿ™ÿ≠ŸÇŸÇ ÿ≥ÿ±Ÿäÿπ ÿ£ŸÜ ÿßŸÑŸÖŸÑŸÅ ŸÖŸà ŸÅÿßÿ±ÿ∫
          PP_SIZE=$(wc -c < "$PP_PATH" | tr -d ' ')
          echo "PP_SIZE=$PP_SIZE"
          if [ "$PP_SIZE" -lt 1000 ]; then
            echo "‚ùå Decoded provisioning profile looks too small."
            exit 1
          fi

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"

          UUID=$(security cms -D -i "$PP_PATH" | /usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin)
          cp "$PP_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"
          echo "‚úÖ Installed provisioning profile UUID: $UUID"

          TEAM_ID=$(security cms -D -i "$PP_PATH" | /usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' /dev/stdin)
          PROFILE_NAME=$(security cms -D -i "$PP_PATH" | /usr/libexec/PlistBuddy -c 'Print :Name' /dev/stdin)
          APP_ID=$(security cms -D -i "$PP_PATH" | /usr/libexec/PlistBuddy -c 'Print :Entitlements:application-identifier' /dev/stdin)
          BUNDLE_ID="${APP_ID#${TEAM_ID}.}"

          # ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑÿ™ÿµÿØŸäÿ± ŸÖŸÜ ŸÜŸÅÿ≥ ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ
          PROV_ALL_DEVICES=$((security cms -D -i "$PP_PATH" | /usr/libexec/PlistBuddy -c 'Print :ProvisionsAllDevices' /dev/stdin) 2>/dev/null || echo "false")
          GET_TASK_ALLOW=$((security cms -D -i "$PP_PATH" | /usr/libexec/PlistBuddy -c 'Print :Entitlements:get-task-allow' /dev/stdin) 2>/dev/null || echo "false")

          if [ "$PROV_ALL_DEVICES" = "true" ]; then
            EXPORT_METHOD="enterprise"elif [ "$GET_TASK_ALLOW" = "true" ]; then
            EXPORT_METHOD="development"
          else
            EXPORT_METHOD="ad-hoc"
          fi

          echo "TEAM_ID=$TEAM_ID" >> "$GITHUB_ENV"
          echo "PROFILE_NAME=$PROFILE_NAME" >> "$GITHUB_ENV"
          echo "BUNDLE_ID=$BUNDLE_ID" >> "$GITHUB_ENV"
          echo "EXPORT_METHOD=$EXPORT_METHOD" >> "$GITHUB_ENV"

          echo "üîé TEAM_ID=$TEAM_ID"
          echo "üîé PROFILE_NAME=$PROFILE_NAME"
          echo "üîé BUNDLE_ID=$BUNDLE_ID"
          echo "üîé EXPORT_METHOD=$EXPORT_METHOD"

      # ---------- Detect scheme correctly (ÿ®ÿØŸàŸÜ contents.xcworkspacedata) ----------
      - name: Detect correct Xcode scheme (exclude EASClient)
        run: |
          set -euo pipefail

          # ÿßÿÆÿ™ÿ± workspace ÿßŸÑÿ≠ŸÇŸäŸÇŸä ÿ•ŸÜ Ÿàÿ¨ÿØ
          WORKSPACE="$(ls ios/*.xcworkspace 2>/dev/null | head -n 1 || true)"
          PROJECT="$(ls ios/*.xcodeproj 2>/dev/null | head -n 1 || true)"

          if [ -n "$WORKSPACE" ]; then
            echo "‚úÖ Using workspace: $WORKSPACE"
            LIST_JSON="$(xcodebuild -list -json -workspace "$WORKSPACE")"
          elif [ -n "$PROJECT" ]; then
            echo "‚úÖ Using project: $PROJECT"
            LIST_JSON="$(xcodebuild -list -json -project "$PROJECT")"
          else
            echo "‚ùå No .xcworkspace or .xcodeproj found under ios/"
            ls -la ios
            exit 1
          fi

          echo "$LIST_JSON" > "$RUNNER_TEMP/list.json"

          # ÿßÿ≥ÿ≠ÿ® ÿ£ŸàŸÑ scheme ŸÑŸäÿ≥ EASClient
          SCHEME="$(python3 - <<'PY'
import json, os
p=os.environ["RUNNER_TEMP"]+"/list.json"
j=json.load(open(p))
schemes = j.get("project",{}).get("schemes",[]) or j.get("workspace",{}).get("schemes",[])
schemes = [s for s in schemes if s and s != "EASClient"]
print(schemes[0] if schemes else "")
PY
)"
          if [ -z "$SCHEME" ]; then
            echo "‚ùå Could not detect a valid scheme (after excluding EASClient)."
            cat "$RUNNER_TEMP/list.json"
            exit 1
          fi

          echo "‚úÖ Using scheme: $SCHEME"
          echo "SCHEME=$SCHEME" >> "$GITHUB_ENV"

          # ÿÆÿ≤ŸëŸÜ ÿ£Ÿäÿ∂ÿßŸã ŸÖÿ≥ÿßÿ± workspace/project ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÑÿßÿ≠ŸÇÿßŸã
          if [ -n "$WORKSPACE" ]; then
            echo "XCODE_WORKSPACE=$WORKSPACE" >> "$GITHUB_ENV"
          else
            echo "XCODE_PROJECT=$PROJECT" >> "$GITHUB_ENV"
          fi

      # ---------- Build archive ----------
      - name: Build Archive (Release)
        run: |
          set -euo pipefail
          cd ios

          SIGN_IDENTITY="iPhone Distribution"   # ŸÑÿ£ŸÜ ŸáŸàŸäÿ™ŸÉ ÿ∏Ÿáÿ±ÿ™ ŸáŸÉÿ∞ÿß ÿØÿßÿÆŸÑ runner
          # ÿ•ÿ∞ÿß ÿπŸÜÿØŸÉ "Apple Distribution" ÿ®ÿØŸÑŸáÿß ŸáŸÜÿß

          if [ -n "${XCODE_WORKSPACE:-}" ]; then
            xcodebuild \
              -workspace "$XCODE_WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration Release \
              -sdk iphoneos \
              -destination "generic/platform=iOS" \
              -archivePath "$RUNNER_TEMP/App.xcarchive" \
              DEVELOPMENT_TEAM="$TEAM_ID" \
              CODE_SIGN_STYLE=Manual \
              "CODE_SIGN_IDENTITY=$SIGN_IDENTITY" \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
              PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
              clean archive
          else
            xcodebuild \
              -project "$XCODE_PROJECT" \
              -scheme "$SCHEME" \
              -configuration Release \
              -sdk iphoneos \
              -destination "generic/platform=iOS" \
              -archivePath "$RUNNER_TEMP/App.xcarchive" \
              DEVELOPMENT_TEAM="$TEAM_ID" \
              CODE_SIGN_STYLE=Manual \
              "CODE_SIGN_IDENTITY=$SIGN_IDENTITY" \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
              PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
              clean archive
          fi

      # ---------- Generate ExportOptions on runner ----------
      - name: Generate ExportOptions.plist on runner (with fallback)
        run: |
          set -euo pipefail

          EXPORT_PLIST="$RUNNER_TEMP/ExportOptions.plist"

          make_plist () {local METHOD="$1"
            cat > "$EXPORT_PLIST" <<PLIST
              <?xml version="1.0" encoding="UTF-8"?>
              <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
              <plist version="1.0">
              <dict>
                <key>method</key>
                <string>${METHOD}</string>
              
                <key>signingStyle</key>
                <string>manual</string>
              
                <key>teamID</key>
                <string>${TEAM_ID}</string>
              
                <key>provisioningProfiles</key>
                <dict>
                  <key>${BUNDLE_ID}</key>
                  <string>${PROFILE_NAME}</string>
                </dict>
              
                <key>compileBitcode</key>
                <false/>
              
                <key>destination</key>
                <string>export</string>
              </dict>
              </plist>
              PLIST
            /usr/bin/plutil -lint "$EXPORT_PLIST"
            echo "‚úÖ ExportOptions.plist ready (method=$METHOD): $EXPORT_PLIST"
          }

          make_plist "$EXPORT_METHOD"

          echo "EXPORT_OPTIONS_PLIST=$EXPORT_PLIST" >> "$GITHUB_ENV"

      # ---------- Export IPA (ÿ¨ÿ±ÿ® enterprise ÿ´ŸÖ fallback ad-hoc ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß) ----------
      - name: Export IPA (try primary method then fallback)
        run: |
          set -euo pipefail

          export_once () {
            local METHOD="$1"
            echo "üöÄ Exporting IPA using method=$METHOD"
            # ÿßÿπÿØ ÿ™ŸàŸÑŸäÿØ plist ÿ®ŸÜŸÅÿ≥ method
            EXPORT_PLIST="$RUNNER_TEMP/ExportOptions.plist"
            /usr/libexec/PlistBuddy -c "Set :method $METHOD" "$EXPORT_PLIST" 2>/dev/null || true

            rm -rf "$RUNNER_TEMP/export"
            mkdir -p "$RUNNER_TEMP/export"

            xcodebuild -exportArchive \
              -archivePath "$RUNNER_TEMP/App.xcarchive" \
              -exportOptionsPlist "$EXPORT_PLIST" \
              -exportPath "$RUNNER_TEMP/export"
          }

          PRIMARY="$EXPORT_METHOD"

          set +e
          export_once "$PRIMARY"
          STATUS=$?
          set -e

          if [ $STATUS -ne 0 ] && [ "$PRIMARY" = "enterprise" ]; then
            echo "‚ö†Ô∏è Export failed with enterprise. Trying fallback: ad-hoc"
            export_once "ad-hoc"
          elif [ $STATUS -ne 0 ]; then
            exit $STATUS
          fi

          echo "‚úÖ Export done. Files:"
          ls -la "$RUNNER_TEMP/export"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: PowerPlantCalculations-ipa
          path: |
            ${{ runner.temp }}/export/*.ipa
            ${{ runner.temp }}/export/*.dSYM
          if-no-files-found: error
